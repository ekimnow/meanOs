!function(){function e(){this.onload=null,this._finished=!1,this.onerror=null,this.opts=null,this.timedOut=!1,this.timeout=0,this.timeoutId=null,this.stream=null,this.connecting=!1,this.writing=!1,this.haderror=!1,this.closed=!1,this.sockInfo=null,this.responseType=null,this.extraHeaders={},this.headersReceived=!1,this.responseHeaders=null,this.responseHeadersParsed=null,this.responseBody=null,this.responseLength=null,this.responseBytesRead=null,this.requestBody=null,this.secured=!1}e.prototype={open:function(e,t,s){this.opts={method:e,url:t,async:!0},this.uri=WSC.parseUri(this.opts.url)},setRequestHeader:function(e,t){this.extraHeaders[e]=t},cancel:function(){this.stream.closed||this.stream.close()},send:function(e){this.requestBody=e,chrome.sockets.tcp.create({},_.bind(this.onCreate,this)),0!==this.timeout&&(this.timeoutId=setTimeout(_.bind(this.checkTimeout,this),this.timeout))},createRequestHeaders:function(){var e=[],t={Host:this.uri.host};for(var s in _.extend(t,this.extraHeaders),"GET"==this.opts.method||("POST"==this.opts.method?this.requestBody?t["Content-Length"]=this.requestBody.byteLength.toString():t["Content-Length"]="0":this.error("unsupported method")),e.push(this.opts.method+" "+this.uri.pathname+this.uri.search+" HTTP/1.1"),t)e.push(s+": "+t[s]);return e.join("\r\n")+"\r\n\r\n"},checkTimeout:function(){this._finished||this.error({error:"timeout"})},error:function(e){this._finished=!0,this.haderror=!0,this.onerror&&(console.assert("object"==typeof e),e.target={error:!0},this.onerror(e)),this.stream.closed||this.stream.close()},onStreamClose:function(e){this._finished||this.error({error:"stream closed"})},onCreate:function(e){if(!this.closed){this.stream=new WSC.IOStream(e.socketId),this.stream.addCloseCallback(this.onStreamClose.bind(this)),this.sockInfo=e,this.connecting=!0;var t=this.getHost(),s=this.getPort();chrome.sockets.tcp.setPaused(e.socketId,!0,function(){chrome.sockets.tcp.connect(e.socketId,t,s,_.bind(this.onConnect,this))}.bind(this))}},onConnect:function(e){var t=chrome.runtime.lastError;if(!this.closed&&(this.connecting=!1,!this.timedOut))if(t)this.error({error:t.message});else if(e<0)this.error({error:"connection error",code:e});else{if("https:"==this.uri.protocol&&!this.secured)return this.secured=!0,void chrome.sockets.tcp.secure(this.sockInfo.socketId,this.onConnect.bind(this));var s=this.createRequestHeaders();this.stream.writeBuffer.add(new TextEncoder("utf-8").encode(s).buffer),this.requestBody&&(this.stream.writeBuffer.add(this.requestBody),this.requestBody=null),this.stream.tryWrite(),this.stream.readUntil("\r\n\r\n",this.onHeaders.bind(this)),chrome.sockets.tcp.setPaused(this.sockInfo.socketId,!1,(function(){}))}},getHost:function(){return this.uri.hostname},getPort:function(){return"https:"==this.uri.protocol?parseInt(this.uri.port)||443:parseInt(this.uri.port)||80},onHeaders:function(e){var t=WSC.ui82str(new Uint8Array(e));this.headersReceived=!0,this.responseHeaders=t;var s=function(e){for(var t=e.split("\r\n"),s=t[0].split(/ +/),r=s[0],i=s[1],n=s.slice(2,s.length).join(" "),o={},h=1;h<t.length;h++){var a=t[h];if(a){var d=a.indexOf(":"),c=a.slice(0,d).toLowerCase();o[c]=a.slice(d+1,a.length).trim()}}return{code:i,status:n,proto:r,headers:o}}(this.responseHeaders);this.responseDataParsed=s,this.responseHeadersParsed=s.headers,this.responseLength=parseInt(s.headers["content-length"]),this.responseBytesRead=this.stream.readBuffer.size(),s.headers["transfer-encoding"]&&"chunked"==s.headers["transfer-encoding"]?(this.chunks=new WSC.Buffer,this.stream.readUntil("\r\n",this.getNewChunk.bind(this))):s.headers["content-length"]?this.stream.readBytes(this.responseLength,this.onBody.bind(this)):this.error("no content length in response")},onChunkDone:function(e){this.chunks.add(e),this.stream.readUntil("\r\n",this.getNewChunk.bind(this))},getNewChunk:function(e){var t=WSC.ui82str(new Uint8Array(e.slice(0,e.byteLength-2))),s=parseInt(t,16);if(isNaN(s))this.error("invalid chunked encoding response");else if(0==s){var r=this.chunks.flatten();this.onBody(r)}else this.stream.readBytes(s+2,this.onChunkDone.bind(this))},onBody:function(e){this.responseBody=e;var t={target:{headers:this.responseDataParsed.headers,code:this.responseDataParsed.code,status:this.responseDataParsed.code,responseHeaders:this.responseHeaders,responseHeadersParsed:this.responseHeadersParsed,response:e}};this.responseType&&"xml"==this.responseType.toLowerCase()&&(t.target.responseXML=(new DOMParser).parseFromString(new TextDecoder("utf-8").decode(e),"text/xml")),this.onload(t),this._finished=!0,this.stream.closed||this.stream.close()}},WSC.ChromeSocketXMLHttpRequest=e,window.testxhr=function(){console.log("creating XHR");var t=new e;t.open("GET","https://www.google.com"),t.timeout=8e3,t.onload=t.onerror=t.ontimeout=function(e){console.log("xhr result:",e)},t.send(),window.txhr=t}}();