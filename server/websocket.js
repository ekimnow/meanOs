!function(){function e(){WSC.BaseHandler.prototype.constructor.call(this),this.ws_connection=null,this.close_code=null,this.close_reason=null,this.stream=null,this._on_close_called=!1}for(var t in e.prototype={get:function(){if("websocket"!=this.getHeader("upgrade","").toLowerCase())return console.log("connection must be upgrade"),this.set_status(400),void this.finish();var e=this.getHeader("origin");if(!this.check_origin(e))return console.log("origin mismatch"),this.set_status(403),void this.finish();this.stream=this.request.connection.stream,this.stream.set_close_callback(this.on_connection_close.bind(this)),this.ws_connection=new i(this),this.ws_connection.accept_connection()},write_message:function(e,t){if(t=t||!1,!this.ws_connection)throw new Error("Websocket not connected");this.ws_connection.write_message(e,t)},select_subprotocols:function(e){},get_compression_options:function(){},ping:function(e){console.assert(this.ws_connection),this.ws_connection.write_ping(e)},on_pong:function(e){},on_close:function(){},close:function(e,t){this.ws_connection&&(this.ws_connection.close(e,t),this.ws_connection=null)},set_nodelay:function(e){this.stream.set_nodelay(e)},on_connection_close:function(){this.ws_connection&&(this.ws_connection.on_connection_close(),this.ws_connection=null),this._on_close_called||(this._on_close_called=!0,this.on_close())},send_error:function(e){this.stream&&this.stream.close()},check_origin:function(e){return!0}},WSC.BaseHandler.prototype)e.prototype[t]=WSC.BaseHandler.prototype[t];var s={FIN:128,RSV1:64,RSV2:32,RSV3:16,OPCODE_MASK:15,MAGIC:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"};function n(e,t){for(var s=new Uint8Array(t),n=new Uint8Array(e),i=0;i<s.length;i++)s[i]^=n[i%4];return s.buffer}function i(e,t){(t=t||{}).mask_outgoing=t.mask_outgoing||!1,t.compression_options=t.compression_options||null,this.handler=e,this.request=e.request,this.stream=e.stream,this.client_terminated=!1,this.server_terminated=!1,this.mask_outgoing=t.mask_outgoing,this._final_frame=!1,this._frame_opcode=null,this._masked_frame=null,this._frame_mask=null,this._frame_length=null,this._fragmented_message_buffer=null,this._fragmented_message_opcode=null,this._waiting=null,this._compression_options=t.compression_options,this._decompressor=null,this._compressor=null,this._frame_compressed=null,this._messages_bytes_in=0,this._messages_bytes_out=0,this._wire_bytes_out=0,this._wire_bytes_out=0}function o(){e.prototype.constructor.call(this)}for(var t in s.RSV_MASK=s.RSV1|s.RSV2|s.RSV3,i.prototype={accept_connection:function(){if(!this._handle_websocket_headers())return this._abort();this._accept_connection()},_challenge_response:function(){return new Promise(function(e,t){var n,i,o,r,_;n=this.request.headers["sec-websocket-key"],i=function(t){e(t)}.bind(this),o=new TextEncoder("utf-8").encode(n),r=new TextEncoder("utf-8").encode(s.MAGIC),(_=new Uint8Array(o.length+s.MAGIC.length)).set(o,0),_.set(r,o.length),crypto.subtle.digest({name:"SHA-1"},_).then((function(e){var t=btoa(WSC.ui82str(new Uint8Array(e)));i(t)}))}.bind(this))},_accept_connection:function(){var e="",t=this.request.headers["sec-websocket-protocol"]||"";if((t=t.split(",").map((function(e){return e.trim()}))).length>0){var s=this.handler.select_subprotocols(t);if(s)e="Sec-Websocket-Protocol: "+s+"\r\n"}for(var n="",i=this._parse_extensions_header(this.request.headers),o=0;o<i.length;o++){var r=i[o];if("permessage-deflate"==r[0]&&this._compression_options){this._create_compressors("server",r[1]),void 0!==r[1].client_max_window_bits&&null===r[1].client_max_window_bits&&delete r[1].client_max_window_bits,n="Sec-Websocket-Extensions: "+WSC.encode_header(permessage-deflate,r[1]);break}}console.assert(""==n),this.stream.closed?this._abort():this._challenge_response().then(function(t){var s=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+t,e+n].join("\r\n")+"\r\n";this.stream.write(new TextEncoder("utf-8").encode(s).buffer),this.handler.open(),this._receive_frame()}.bind(this))},_parse_extensions_header:function(e){e["sec-websocket-extensions"];return[]},_process_server_headers:function(){},_get_compressor_options:function(e,t){},_create_compressors:function(e,t){},_write_frame:function(e,t,i,o){var r;o|=0;var _=e?s.FIN:0,a=[];(r=new Uint8Array(1))[0]=_|t|o,a.push(r);var h=i.byteLength,c=this.mask_outgoing?128:0;if(h<126?(r=new Uint8Array(1))[0]=h|c:h<=65535?((r=new Uint8Array(3))[0]=126|c,new DataView(r.buffer).setUint16(1,h)):((r=new Uint8Array(9))[0]=127|c,new DataView(r.buffer).setUint32(5,h)),a.push(r),this.mask_outgoing){var f=new Uint8Array(4);crypto.getRandomValues(f),a.push(f),a.push(n(f,i))}else a.push(i);for(var l=0;l<a.length;l++)this.stream.writeBuffer.add(a[l].buffer||a[l]);this.stream.tryWrite()},write_message:function(e,t){var s=t?2:1;if(t)if(e instanceof ArrayBuffer)n=e;else var n=new TextEncoder("utf-8").encode(e).buffer;else n=new TextEncoder("utf-8").encode(e).buffer;this._messages_bytes_out+=e.byteLength;this._compressor,this._write_frame(!0,s,n,0)},write_ping:function(e){console.assert(e instanceof ArrayBuffer),this._write_frame(!0,9,e)},_receive_frame:function(){this.stream.readBytes(2,this._on_frame_start.bind(this))},_on_frame_start:function(e){this._wire_bytes_in+=e.byteLength;var t=new DataView(e,0,2),n=t.getUint8(0),i=t.getUint8(1);this._final_frame=n&s.FIN;var o=n&s.RSV_MASK;this._frame_opcode=n&s.OPCODE_MASK,this._frame_opcode_is_control=8&this._frame_opcode,this._decompressor&&0!=this._frame_opcode||(o?this._abort():(this._masked_frame=!!(128&i),i&=127,this._frame_opcode_is_control&&i>=126?this._abort():i<126?(this._frame_length=i,this._masked_frame?this.stream.readBytes(4,this._on_masking_key.bind(this)):this.stream.readBytes(this._frame_length,this._on_frame_data.bind(this))):126==i?this.stream.readBytes(2,this._on_frame_length_16.bind(this)):127==i&&this.stream.readBytes(8,this._on_frame_length_64.bind(this))))},_on_frame_length_16:function(e){this._wire_bytes_in+=e.byteLength;var t=new DataView(e,0,2);this._frame_length=t.getUint16(0),this._on_frame_length_n(e)},_on_frame_length_64:function(e){this._wire_bytes_in+=e.byteLength;var t=new DataView(e,0,8);this._frame_length=t.getUint32(4),this._on_frame_length_n(e)},_on_frame_length_n:function(e){this._masked_frame?this.stream.readBytes(4,this._on_masking_key.bind(this)):this.stream.readBytes(this._frame_length,this._on_frame_data.bind(this))},_on_masking_key:function(e){this._wire_bytes_in+=e.byteLength,this._frame_mask=e,this.stream.readBytes(this._frame_length,this._on_masked_frame_data.bind(this))},_on_masked_frame_data:function(e){this._on_frame_data(n(this._frame_mask,e))},_on_frame_data:function(e){var t;if(this._wire_bytes_in+=e.byteLength,this._frame_opcode_is_control){if(!this._final_frame)return void this._abort();t=this._frame_opcode}else if(0==this._frame_opcode){if(!this._fragmented_message_buffer)return void this._abort();this._fragmented_message_buffer.push(e),this._final_frame&&(t=this._fragmented_message_opcode,console.warn,e=this._fragmented_message_buffer,this._fragmented_message_buffer=null)}else{if(this._fragmented_message_buffer)return void this._abort();this._final_frame?t=this._frame_opcode:(this._fragmented_message_opcode=this._frame_opcode,this._fragmented_message_buffer=[e])}this._final_frame&&this._handle_message(t,e),this.client_terminated||this._receive_frame()},_handle_message:function(e,t){if(!this.client_terminated)if(this._frame_compressed,1==e){this._messages_bytes_in+=t.byteLength;var s=new TextDecoder("utf-8").decode(t);this._run_callback(this.handler.on_message,this.handler,s)}else if(2==e)this._messages_bytes_in+=t.byteLength,this._run_callback(this.handler.on_message,this.handler,t);else if(8==e){if(this.client_terminated=!0,t.byteLength>=2){var n=new DataView(t,0,2);this.handler.close_code=n.getUint16(0)}t.byteLength>2&&(this.handler.close_reason=new TextDecoder("utf-8").decode(t.slice(2,t.byteLength))),this.close(this.handler.close_code)}else 9==e?this._write_frame(!0,10,t):10==e?this._run_callback(this.handler.on_pong,this.handler,t):this._abort()},close:function(e,t){if(!this.server_terminated){if(!this.stream.closed){var s;if(!e&&t&&(e=1e3),e||0===e){var n=new ArrayBuffer(2);new DataView(n).setUint16(0,e),s=n}else s=new ArrayBuffer(0);if(t){var i=new TextEncoder("utf-8").encode(t),o=new Uint8Array(s.byteLength+i.length);o.set(s,0),o.set(i,s.byteLength),s=o.buffer}this._write_frame(!0,8,s)}this.server_terminated=!0}this.client_terminated?this._waiting&&(clearTimeout(this._waiting),this._waiting=null):this._waiting||(this._waiting=setTimeout(function(){this._abort()}.bind(this),5))},_handle_websocket_headers:function(){for(var e=["host","sec-websocket-key","sec-websocket-version"],t=0;t<e.length;t++)if(!this.request.headers[e[t]])return!1;return!0},on_connection_close:function(){this._abort()},_run_callback:function(e,t){e.apply(t,Array.prototype.slice.call(arguments,2,arguments.length))},_abort:function(){this.client_terminated=!0,this.server_terminated=!0,this.stream.close(),this.close()}},o.prototype={open:function(){console.log("websocket handler handler.open()"),window.ws=this},on_message:function(e){console.log("got ws message",e,e.byteLength,new Uint8Array(e))},on_close:function(){}},e.prototype)o.prototype[t]=e.prototype[t];WSC.ExampleWebSocketHandler=o,WSC.WebSocketHandler=e}();