!function(){function e(e,t){WSC.BaseHandler.prototype.constructor.call(this),this.validator=e}function t(e,t){WSC.BaseHandler.prototype.constructor.call(this),this.fs=e,this.entry=null,this.file=null,this.readChunkSize=65536,this.fileOffset=0,this.fileEndOffset=0,this.bodyWritten=0,this.isDirectoryListing=!1,t.connection.stream.onclose=this.onClose.bind(this)}_DEBUG=!1,_.extend(e.prototype,{get:function(){if(!this.validator(this.request))return this.responseLength=0,this.writeHeaders(403),void this.finish();console.log("proxyhandler get",this.request);var e=this.request.arguments.url,t=new WSC.ChromeSocketXMLHttpRequest,i={"Accept-Language":"en-US,en;q=0.8","Cache-Control":"no-cache",Pragma:"no-cache","Upgrade-Insecure-Requests":"1","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.110 Safari/537.36"};for(var s in i)t.setRequestHeader(s,i[s]);t.open("GET",e),t.onload=this.onfetched.bind(this),t.send()},onfetched:function(e){for(var t in e.target.headers)this.setHeader(t,e.target.headers[t]);this.responseLength=e.target.response.byteLength,this.writeHeaders(e.target.code),this.write(e.target.response),this.finish()}},WSC.BaseHandler.prototype),WSC.ProxyHandler=e,_.extend(t.prototype,{onClose:function(){clearInterval(this.debugInterval)},debug:function(){},head:function(){this.get()},put:function(){if(!this.app.opts.optUpload)return this.responseLength=0,this.writeHeaders(400),void this.finish();this.fs.getByPath(this.request.path,this.onPutEntry.bind(this),!0)},onPutEntry:function(e){var t=this.request.path.split("/"),i=t.slice(0,t.length-1).join("/"),s=t[t.length-1];if(e&&"path not found"==e.error)this.fs.getByPath(i,this.onPutFolder.bind(this,s));else{console.log("file already exists",e);var r=function(e){this.fs.getByPath(i,this.onPutFolder.bind(this,s))}.bind(this);e.remove(r,r)}},onPutFolder:function(e,t){var i=function(e){console.log("write complete",e),this.responseLength=0,this.writeHeaders(200),this.finish()}.bind(this),s=this.request.body;function r(e){if(e&&e.isFile){function t(e){e.onwrite=e.onerror=i,e.write(new Blob([s]))}e.createWriter(t,t)}}t.getFile(e,{create:!0},r,r)},get:function(){this.setHeader("accept-ranges","bytes"),this.setHeader("connection","keep-alive"),this.fs?this.rewrite_to?this.fs.getByPath(this.rewrite_to,this.onEntry.bind(this)):this.fs.isFile?this.onEntry(this.fs):this.fs.getByPath(this.request.path,this.onEntry.bind(this)):this.write("error: need to select a directory to serve",500)},doReadChunk:function(){var e=new FileReader,t=Math.min(this.fileOffset+this.readChunkSize,this.fileEndOffset);t>=this.file.size&&(console.error("bad readChunk"),console.assert(!1)),e.onload=this.onReadChunk.bind(this),e.onerror=this.onReadChunk.bind(this);var i=this.file.slice(this.fileOffset,t+1);this.fileOffset;this.fileOffset+=t-this.fileOffset+1,e.readAsArrayBuffer(i)},onWriteBufferEmpty:function(){if(this.file)if(console.assert(this.bodyWritten<=this.responseLength),this.bodyWritten>this.responseLength)console.assert(!1);else{if(this.bodyWritten==this.responseLength)return this.request.connection.stream.onWriteBufferEmpty=null,void this.finish();this.request.connection.stream.remoteclosed?this.request.connection.close():this.request.connection.stream.closed||this.doReadChunk()}else console.error("!this.file")},onReadChunk:function(e){e.target.result?(this.bodyWritten+=e.target.result.byteLength,this.bodyWritten,this.responseLength,this.request.connection.write(e.target.result)):(console.error("onreadchunk error",e.target.error),this.request.connection.close())},onEntry:function(e){if(this.entry=e,this.entry&&this.entry.isDirectory&&!this.request.origpath.endsWith("/")){var t=this.request.origpath+"/";return this.setHeader("location",t),this.responseLength=0,this.writeHeaders(301),void this.finish()}if(this.request.connection.stream.closed)console.warn(this.request.connection.stream.sockId,"request closed while processing request");else if(e)if(e.error)"HEAD"==this.request.method?(this.responseLength=0,this.writeHeaders(404),this.finish()):this.write("entry not found: "+(this.rewrite_to||this.request.path),404);else if(e.isFile)this.renderFileContents(e);else{var i=e.createReader(),s=[];function r(e){WSC.entryCache.unset(this.entry.filesystem.name+this.entry.fullPath),console.error("error reading dir",e),this.request.connection.close()}function n(e){if(this.app.opts.optRenderIndex)for(var t=0;t<e.length;t++){if("index.xhtml"==e[t].name||"index.xhtm"==e[t].name)return this.setHeader("content-type","application/xhtml+xml; charset=utf-8"),void this.renderFileContents(e[t]);if("index.html"==e[t].name||"index.htm"==e[t].name)return this.setHeader("content-type","text/html; charset=utf-8"),void this.renderFileContents(e[t])}this.request.arguments&&"1"==this.request.arguments.json||this.request.headers.accept&&"application/json"==this.request.headers.accept.toLowerCase()?this.renderDirectoryListingJSON(e):this.request.arguments&&"1"==this.request.arguments.static||"true"==this.request.arguments.static||this.app.opts.optStatic?this.renderDirectoryListing(e):this.renderDirectoryListingTemplate(e)}this.isDirectoryListing=!0,i.readEntries(function e(t){0==t.length?n.bind(this)(s):(s=s.concat(t),i.readEntries(e.bind(this),r.bind(this)))}.bind(this),r.bind(this))}else"HEAD"==this.request.method?(this.responseLength=0,this.writeHeaders(404),this.finish()):this.write("no entry",404)},renderFileContents:function(e,t){!function(e,t){var i=e.filesystem.name+"/"+e.fullPath,s=WSC.entryFileCache.get(i);s?t(s):e.file((function(e){t(e)}),(function(e){console.error("entry.file() error",e),e.error=!0,t(e)}))}(e,function(e){if(e instanceof DOMException)return this.write("File not found",404),void this.finish();if(this.file=e,"HEAD"==this.request.method)this.responseLength=this.file.size,this.writeHeaders(200),this.finish();else if(this.file.size>8*this.readChunkSize||this.request.headers.range)if(this.request.connection.stream.onWriteBufferEmpty=this.onWriteBufferEmpty.bind(this),this.request.headers.range){console.log(this.request.connection.stream.sockId,"RANGE",this.request.headers.range);var t=this.request.headers.range.split("=")[1].trim().split("-");t[1]?(this.fileOffset=parseInt(t[0]),this.fileEndOffset=parseInt(t[1]),this.responseLength=this.fileEndOffset-this.fileOffset+1,this.setHeader("content-range","bytes "+this.fileOffset+"-"+this.fileEndOffset+"/"+this.file.size),this.writeHeaders(206)):(this.fileOffset=parseInt(t[0]),this.fileEndOffset=this.file.size-1,this.responseLength=this.file.size-this.fileOffset,this.setHeader("content-range","bytes "+this.fileOffset+"-"+(this.file.size-1)+"/"+this.file.size),0==this.fileOffset?this.writeHeaders(200):this.writeHeaders(206))}else _DEBUG&&console.log("large file, streaming mode!"),this.fileOffset=0,this.fileEndOffset=this.file.size-1,this.responseLength=this.file.size,this.writeHeaders(200);else{var i=new FileReader,s=this.onReadEntry.bind(this);i.onload=s,i.onerror=s,i.readAsArrayBuffer(e)}}.bind(this))},entriesSortFunc:function(e,t){var i=e.name.toLowerCase(),s=t.name.toLowerCase();return e.isDirectory&&t.isDirectory?i.localeCompare(s):e.isDirectory?-1:t.isDirectory?1:i.localeCompare(s)},renderDirectoryListingJSON:function(e){this.setHeader("content-type","application/json; charset=utf-8"),this.write(JSON.stringify(e.map((function(e){return{name:e.name,fullPath:e.fullPath,isFile:e.isFile,isDirectory:e.isDirectory}})),null,2))},renderDirectoryListingTemplate:function(e){if(!WSC.template_data)return this.renderDirectoryListing(e);this.setHeader("transfer-encoding","chunked"),this.writeHeaders(200),this.writeChunk(WSC.template_data);for(var t=['<script>start("current directory...")<\/script>','<script>addRow("..","..",1,"170 B","10/2/15, 8:32:45 PM");<\/script>'],i=0;i<e.length;i++){var s=e[i].name,r=encodeURIComponent(e[i].name),n=e[i].isDirectory;t.push('<script>addRow("'+s+'","'+r+'",'+n+',"","");<\/script>')}var o=t.join("\n");o=new TextEncoder("utf-8").encode(o).buffer,this.writeChunk(o),this.request.connection.write(WSC.str2ab("0\r\n\r\n")),this.finish()},renderDirectoryListing:function(e){var t=["<html>"];t.push("<style>li.directory {background:#aab}</style>"),t.push('<a href="../?static=1">parent</a>'),t.push("<ul>"),e.sort(this.entriesSortFunc);for(var i=0;i<e.length;i++){var s=_.escape(e[i].name);e[i].isDirectory?t.push('<li class="directory"><a href="'+s+'/?static=1">'+s+"</a></li>"):t.push('<li><a href="'+s+'?static=1">'+s+"</a></li>")}t.push("</ul></html>"),this.setHeader("content-type","text/html; charset=utf-8"),this.write(t.join("\n"))},onReadEntry:function(e){"error"==e.type?(console.error("error reading",e.target.error),WSC.entryFileCache.unset(this.entry.filesystem.name+"/"+this.entry.fullPath),this.request.connection.close()):this.write(e.target.result)}},WSC.BaseHandler.prototype),chrome.runtime.id,WSC.store_id,chrome.runtime.getPackageDirectoryEntry((function(e){var t=function(e){if(e instanceof DOMException)console.error("template fetch:",e);else{var t=function(e){var t=function(e){WSC.template_data=e.target.result},i=new FileReader;i.onload=t,i.onerror=t,i.readAsArrayBuffer(e)};e.file(t,t)}};e.getFile("directory-listing-template.html",{create:!1},t,t)})),WSC.DirectoryEntryHandler=t}();