!function(){function e(e){this.stream=e,this.curRequest=null,this.onRequestCallback=null,this.closed=!1}_DEBUG=!1,e.prototype={log:function(e){console.log(this.stream.sockId,e)},tryRead:function(){this.stream.readUntil("\r\n\r\n",this.onHeaders.bind(this))},write:function(e){if("string"==typeof e)var t=WSC.stringToUint8Array(e).buffer;else t=e;this.stream.writeBuffer.add(t),this.stream.tryWrite()},close:function(){console.log("http conn close"),this.closed=!0,this.stream.close()},addRequestCallback:function(e){this.onRequestCallback=e},onHeaders:function(e){var t=WSC.arrayBufferToString(e).split("\r\n"),s=t[0].split(" "),n=s[0],o=s[1],r=s[2],i=WSC.parseHeaders(t.slice(1,t.length-2));if(this.curRequest=new WSC.HTTPRequest({headers:i,method:n,uri:o,version:r,connection:this}),_DEBUG&&this.log(this.curRequest.uri),i["content-length"]){var c=parseInt(i["content-length"]);c>0?(console.log("request had content length",c),this.stream.readBytes(c,this.onRequestBody.bind(this))):(console.log("request had an empty body"),this.curRequest.body=new Uint8Array(0),this.onRequestBody(this.curRequest.body))}else["GET","HEAD","PUT","OPTIONS"].includes(n)?this.onRequest(this.curRequest):console.error("how to handle",this.curRequest)},onRequestBody:function(e){var t=this.curRequest,s=t.headers["content-type"];if(s&&(s=s.toLowerCase()).toLowerCase().startsWith("application/x-www-form-urlencoded")){var n=s.indexOf("charset=");if(-1!=n){var o=s.slice(n+"charset=".length,s.length);console.log("using charset",o)}else o="utf-8";for(var r={},i=new TextDecoder(o).decode(e).split("&"),c=0;c<i.length;c++){var a=i[c].replace(/\+/g," ").split("=");r[decodeURIComponent(a[0])]=decodeURIComponent(a[1])}t.bodyparams=r}this.curRequest.body=e,this.onRequest(this.curRequest)},onRequest:function(e){this.onRequestCallback(e)}},WSC.HTTPConnection=e}();