!function(){var t=chrome.sockets;function e(t){if(WSC.DEBUG&&console.log("initialize webapp with opts",t),t=t||{},this.id=Math.random().toString(),this.opts=t,this.handlers=t.handlers||[],this.init_handlers(),this.sockInfo=null,this.lasterr=null,this.stopped=!1,this.starting=!1,this.start_callback=null,this._stop_callback=null,this.started=!1,this.fs=null,this.streams={},this.upnp=null,t.retainstr&&chrome.fileSystem.restoreEntry(t.retainstr,function(t){t?this.on_entry(t):this.error("error setting up retained entry")}.bind(this)),t.entry&&this.on_entry(t.entry),this.host=this.get_host(),this.port=parseInt(t.port||8887),this._idle_timeout_id=null,this.on_status_change=null,this.interfaces=[],this.interface_retry_count=0,this.urls=[],this.extra_urls=[],this.port>65535||this.port<1024){var e="bad port: "+this.port;this.error(e)}this.acceptQueue=[]}function s(){this.headersWritten=!1,this.responseCode=null,this.responseHeaders={},this.responseData=[],this.responseLength=null}function r(t){this.entry=t}e.prototype={processAcceptQueue:function(){for(console.log("process accept queue len",this.acceptQueue.length);this.acceptQueue.length>0;){var t=this.acceptQueue.shift();this.onAccept(t)}},updateOption:function(t,e){switch(WSC.VERBOSE&&console.log("updateOption",t,e),this.opts[t]=e,t){case"optDoPortMapping":e||this.upnp&&this.upnp.removeMapping(this.port,"TCP",function(t){console.log("result of removing port mapping",t),this.extra_urls=[],this.upnp=null}.bind(this))}},get_info:function(){return{interfaces:this.interfaces,urls:this.urls,opts:this.opts,started:this.started,starting:this.starting,stopped:this.stopped,lasterr:this.lasterr}},updatedSleepSetting:function(){this.started?this.opts.optPreventSleep?(console.log("requesting keep awake system"),chrome.power.requestKeepAwake(chrome.power.Level.SYSTEM)):(console.log("releasing keep awake system"),chrome.power.releaseKeepAwake()):chrome.power.releaseKeepAwake()},on_entry:function(t){var e=new WSC.FileSystem(t);this.fs=e,this.add_handler([".*",WSC.DirectoryEntryHandler.bind(null,e)]),this.init_handlers(),WSC.DEBUG},get_host:function(){return WSC.getchromeversion()>=44&&this.opts.optAllInterfaces?this.opts.optIPV6?this.opts.host||"::":this.opts.host||"0.0.0.0":this.opts.host||"127.0.0.1"},add_handler:function(t){this.handlers.push(t)},init_handlers:function(){this.handlersMatch=[];for(var t=0;t<this.handlers.length;t++){var e=this.handlers[t][0];this.handlersMatch.push([new RegExp(e),this.handlers[t][1]])}this.change()},change:function(){this.on_status_change&&this.on_status_change()},start_success:function(t){this.opts.optPreventSleep&&(console.log("requesting keep awake system"),chrome.power.requestKeepAwake(chrome.power.Level.SYSTEM));var e=this.start_callback;this.start_callback=null,this.registerIdle(),e&&e(this.get_info()),this.change()},error:function(t){this.opts.optPreventSleep&&chrome.power.releaseKeepAwake(),this.interface_retry_count=0;var e=this.start_callback;this.starting=!1,this.stopped=!0,this.start_callback=null,console.error("webapp error:",t),this.lasterr=t,this.change(),e&&e({error:t})},stop:function(t,e){if(this.lasterr="",this.urls=[],this.change(),e&&(this._stop_callback=e),console.log("meanServer stop:",t),this.starting)console.error("cant stop, currently starting");else{if(this.clearIdle(),WSC.VERBOSE&&console.log("trying release keep awake"),chrome.power&&chrome.power.releaseKeepAwake(),!this.started)return console.warn("meanServer already stopped..."),void this.change();for(var s in this.started=!1,this.stopped=!0,chrome.sockets.tcpServer.disconnect(this.sockInfo.socketId,this.onDisconnect.bind(this,t)),this.streams)this.streams[s].close();this.change()}},onClose:function(t,e){var s=chrome.runtime.lastError;s&&console.warn(s),this.stopped=!0,this.started=!1,this._stop_callback&&this._stop_callback(t),WSC.VERBOSE&&console.log("tcpserver onclose",e)},onDisconnect:function(t,e){var s=chrome.runtime.lastError;s&&console.warn(s),this.stopped=!0,this.started=!1,WSC.VERBOSE&&console.log("tcpserver ondisconnect",e),this.sockInfo&&chrome.sockets.tcpServer.close(this.sockInfo.socketId,this.onClose.bind(this,t))},onStreamClose:function(t){if(console.assert(t.sockId),this.opts.optStopIdleServer)for(var e in this.streams){this.registerIdle();break}delete this.streams[t.sockId]},clearIdle:function(){WSC.VERBOSE&&console.log("clearIdle"),this._idle_timeout_id&&(clearTimeout(this._idle_timeout_id),this._idle_timeout_id=null)},registerIdle:function(){this.opts.optStopIdleServer&&(console.log("registerIdle"),this._idle_timeout_id=setTimeout(this.checkIdle.bind(this),this.opts.optStopIdleServer))},checkIdle:function(){if(this.opts.optStopIdleServer){for(var t in WSC.VERBOSE&&console.log("checkIdle"),this.streams)return void console.log("hit checkIdle, but had streams. returning");this.stop("idle")}},start:function(t){this.lasterr=null,this.starting||this.started?console.error("already starting or started"):(this.start_callback=t,this.stopped=!1,this.starting=!0,this.change(),0==this.interfaces.length&&this.opts.optAllInterfaces?this.getInterfaces({interface_retry_count:0},this.startOnInterfaces.bind(this)):this.startOnInterfaces())},startOnInterfaces:function(){this.tryListenOnPort({port_attempts:0},this.onListenPortReady.bind(this))},onListenPortReady:function(t){t.error?this.error(t):(WSC.VERBOSE&&console.log("listen port ready",t),this.port=t.port,this.opts.optAllInterfaces&&this.opts.optDoPortMapping?(console.clog("WSC","doing port mapping"),this.upnp=new WSC.UPNP({port:this.port,udp:!1,searchtime:2e3}),this.upnp.reset(this.onPortmapResult.bind(this))):this.onReady())},onPortmapResult:function(t){var e=this.upnp.validGateway;if(console.log("portmap result",t,e),t&&!t.error&&e.device&&e.device.externalIP){var s=e.device.externalIP;this.extra_urls=[{url:"http://"+s+":"+this.port}]}this.onReady()},onReady:function(){this.ensureFirewallOpen(),this.starting=!1,this.started=!0,console.log("Listening on","http://"+this.get_host()+":"+this.port+"/"),this.bindAcceptCallbacks(),this.init_urls(),this.start_success({urls:this.urls})},init_urls:function(){this.urls=[].concat(this.extra_urls),this.urls.push({url:"http://127.0.0.1:"+this.port});for(var t=0;t<this.interfaces.length;t++){var e=this.interfaces[t];64===e.prefixLength?this.urls.push({url:"http://["+e.address+"]:"+this.port}):this.urls.push({url:"http://"+e.address+":"+this.port})}return this.urls},computePortRetry:function(t){return this.port+3*t+2*Math.pow(t,2)},tryListenOnPort:function(e,s){t.tcpServer.getSockets(function(t){if(0==t.length)this.doTryListenOnPort(e,s);else{var r=t.filter((function(t){return"WSCListenSocket"==t.name}));if(r&&1==r.length){var i=r[0];return console.log("adopting existing persistent socket",i),this.sockInfo=i,this.port=i.localPort,void s({port:i.localPort})}this.doTryListenOnPort(e,s)}}.bind(this))},doTryListenOnPort:function(e,s){var r=this.opts.optBackground?{name:"WSCListenSocket",persistent:!0}:{};t.tcpServer.create(r,this.onServerSocket.bind(this,e,s))},onServerSocket:function(e,s,r){var i=this.get_host();this.sockInfo=r;var o=this.computePortRetry(e.port_attempts);e.port_attempts++,t.tcpServer.listen(this.sockInfo.socketId,i,o,function(t){var r=chrome.runtime.lastError;if(r||t<0)if(console.log("lasterr listen on port",o,r,t),this.opts.optTryOtherPorts&&e.port_attempts<5)this.tryListenOnPort(e,s);else{var i={error:"Could not listen",attempts:e.port_attempts,code:t,lasterr:r};s(i)}else s({port:o})}.bind(this))},getInterfaces:function(t,e){console.clog("WSC","no interfaces yet",t),chrome.system.network.getNetworkInterfaces(function(s){if(console.log("network interfaces",s),s)for(var r=0;r<s.length;r++)if(this.opts.optIPV6||s[r].prefixLength>=24){if(s[r].address.startsWith("fe80::"))continue;this.interfaces.push(s[r]),console.log("found interface address: "+s[r].address)}0==this.interfaces.length&&this.optRetryInterfaces?(t.interface_retry_count++,t.interface_retry_count>5?e():setTimeout(function(){this.getInterfaces(t,e)}.bind(this),1e3)):e()}.bind(this))},refreshNetworkInterfaces:function(t){this.stop("refreshNetworkInterfaces",function(){this.start(t)}.bind(this))},ensureFirewallOpen:function(){this.opts.optAllInterfaces&&0==chrome.app.window.getAll().length&&0==chrome.app.window.getAll().length&&window.create_hidden&&create_hidden()},bindAcceptCallbacks:function(){t.tcpServer.onAcceptError.addListener(this.onAcceptError.bind(this)),t.tcpServer.onAccept.addListener(this.onAccept.bind(this))},onAcceptError:function(t){t.socketId==this.sockInfo.socketId&&console.error("accept error",this.sockInfo.socketId,t)},onAccept:function(t){if(t.socketId==this.sockInfo.socketId&&t.socketId){var e=new WSC.IOStream(t.clientSocketId);this.adopt_stream(t,e)}},adopt_stream:function(t,e){this.clearIdle(),this.streams[t.clientSocketId]=e,e.addCloseCallback(this.onStreamClose.bind(this));var s=new WSC.HTTPConnection(e);s.addRequestCallback(this.onRequest.bind(this,e,s)),s.tryRead()},onRequest:function(t,e,s){if(console.log("Request",s.method,s.uri),this.opts.auth){var r=!1,i=s.headers.authorization;if(i&&"basic "==i.slice(0,6).toLowerCase()){var o=atob(i.slice(6,i.length)).split(":");o[0]==this.opts.auth.username&&o[1]==this.opts.auth.password&&(r=!0)}if(!r)return(a=new WSC.BaseHandler(s)).app=this,a.request=s,a.setHeader("WWW-Authenticate","Basic"),a.write("",401),void a.finish()}if(this.opts.optModRewriteEnable){var n=s.uri.match(this.opts.optModRewriteRegexp);if(null===n&&this.opts.optModRewriteNegate||null!==n&&!this.opts.optModRewriteNegate)console.log("Mod rewrite rule matched",n,this.opts.optModRewriteRegexp,s.uri),(a=new WSC.DirectoryEntryHandler(this.fs,s)).rewrite_to=this.opts.optModRewriteTo}function h(r,i,o){o.connection=e,o.app=i,o.request=s,t.lastHandler=o;var n=o[s.method.toLowerCase()],h=o["before_"+s.method.toLowerCase()];if(h&&h.apply(o,r),n)return n.apply(o,r),!0}var a,c=!1;if(a)c=h(null,this,a);else for(var l=0;l<this.handlersMatch.length;l++){var p=this.handlersMatch[l][0].exec(s.uri);if(p)if(c=h(p.slice(1),this,new(0,this.handlersMatch[l][1])(s)))break}c||(console.error("unhandled request",s),(a=new WSC.BaseHandler(s)).app=this,a.request=s,a.write("Unhandled request. Did you select a folder to serve?",404),a.finish())}},_.extend(s.prototype,{options:function(){this.app.opts.optCORS?(this.set_status(200),this.finish()):(this.set_status(403),this.finish())},setCORS:function(){this.setHeader("access-control-allow-origin","*"),this.setHeader("access-control-allow-methods","GET, POST, PUT"),this.setHeader("access-control-max-age","120")},get_argument:function(t,e){return void 0!==this.request.arguments[t]?this.request.arguments[t]:e},getHeader:function(t,e){return this.request.headers[t]||e},setHeader:function(t,e){this.responseHeaders[t]=e},set_status:function(t){console.assert(!this.headersWritten),this.responseCode=t},writeHeaders:function(t,e){(void 0===t||isNaN(t))&&(t=this.responseCode||200),this.headersWritten=!0;var s=[];200==t?s.push("HTTP/1.1 200 OK"):s.push("HTTP/1.1 "+t+" "+WSC.HTTPRESPONSES[t]),"chunked"===this.responseHeaders["transfer-encoding"]||(WSC.VERBOSE&&console.log(this.request.connection.stream.sockId,"response code",t,"clen",this.responseLength),console.assert("number"==typeof this.responseLength),s.push("content-length: "+this.responseLength));var r=this.request.path.split(".");if(r.length>1&&!this.isDirectoryListing){var i=r[r.length-1].toLowerCase(),o=WSC.MIMETYPES[i];if(o){_.contains(["text/html","text/xml","text/plain","text/vnd.wap.wml","application/javascript","application/rss+xml"],o)&&(o+="; charset=utf-8"),this.setHeader("content-type",o)}}for(key in this.app.opts.optCORS&&this.setCORS(),this.responseHeaders)s.push(key+": "+this.responseHeaders[key]);s.push("\r\n");var n=s.join("\r\n");this.request.connection.write(n,e)},writeChunk:function(t){console.assert(void 0!==t.byteLength);var e=t.byteLength.toString(16)+"\r\n";this.request.connection.write(WSC.str2ab(e)),this.request.connection.write(t),this.request.connection.write(WSC.str2ab("\r\n"))},write:function(t,e,s){"string"==typeof t&&(t=new TextEncoder("utf-8").encode(t).buffer),console.assert(void 0!==t.byteLength),void 0===e&&(e=200),this.responseData.push(t),this.responseLength+=t.byteLength,this.headersWritten||this.writeHeaders(e);for(var r=0;r<this.responseData.length;r++)this.request.connection.write(this.responseData[r]);this.responseData=[],!1!==s&&this.finish()},finish:function(){this.headersWritten||(this.responseLength=0,this.writeHeaders()),this.beforefinish&&this.beforefinish(),this.request.connection.curRequest=null,this.request.isKeepAlive()&&!this.request.connection.stream.remoteclosed?(this.request.connection.tryRead(),WSC.DEBUG):(console.assert(!this.request.connection.stream.onWriteBufferEmpty),this.request.connection.stream.onWriteBufferEmpty=()=>{this.request.connection.close(),WSC.DEBUG})}}),_.extend(r.prototype,{getByPath:function(t,e,s){if("/"!=t){var r=t.split("/"),i=r.slice(1,r.length);WSC.recursiveGetEntry(this.entry,i,e,s)}else e(this.entry)}}),WSC.FileSystem=r,WSC.BaseHandler=s,WSC.WebApplication=e}();