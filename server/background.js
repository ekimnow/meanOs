console.log("background.js");var OS,localOptions,ALARMID="check_wsc_periodic",WSCID="ofhbbkphhbklhfoeikjpcbhemlocgigb",HADEVENT=!1;function onchoosefolder(e){if(e){var o={retainstr:chrome.fileSystem.retainEntry(e)};chrome.storage.local.set(o),console.log("set retainstr!");var t=get_webapp();if(t){var n=new WSC.FileSystem(e);t.fs=n,t.handlers=[],t.add_handler([".*",WSC.DirectoryEntryHandler.bind(null,n)]),t.init_handlers(),t.change()}}}function settings_ready(e){localOptions=e,console.log("settings:",e),setTimeout(maybeStartup,2e3)}function maybeStartup(){getting_settings||had_backgroundaccept||localOptions.optBackground&&localOptions.optAutoStart&&(console.log("background && autostart. wake up!"),get_webapp(localOptions),app.started||app.starting||app.starting_interfaces?console.log("actually, dont wake up, im already started/starting"):app.start())}function onAlarm(e){console.log("alarm fired",e),e.name}function backgroundSettingChange(e){void 0!==e.optBackground&&(localOptions.optBackground=e.optBackground),void 0!==e.optPreventSleep&&(localOptions.optPreventSleep=e.optPreventSleep),void 0!==e.optBackground&&(localOptions.optAutoStart=e.optAutoStart)}function onAllAlarms(e){}function createNotification(e,o){var t={type:"basic",title:e,iconUrl:"/images/200ok-256.png",message:e};chrome.notifications.create("suspending",t,(function(){}))}function triggerKeepAwake(){console.log("triggerKeepAwake");var e=new XMLHttpRequest;function o(e){console.log("triggerKeepAwake XHR loaded",e)}e.open("GET","http://127.0.0.1:"+(localOptions.port||8887)+"/dummyUrlPing"),e.onerror=o,e.onload=o,e.send()}OS=navigator.userAgent.match("OS X")?"Mac":navigator.userAgent.match("Windows")?"Win":"Chrome",chrome.storage.local.get(null,settings_ready),chrome.runtime.onStartup.addListener((function(e){HADEVENT=!0,window.ONSTARTUP_FIRED=!0,console.log("onStartup",e)})),chrome.sockets.tcpServer.onAccept.addListener(backgroundAccept);var bgacceptqueue=[],getting_settings=!1,had_backgroundaccept=!1;function backgroundAccept(e){function o(e){getting_settings=!1,localOptions=e,console.log("starting..."),get_webapp(e).start((function(e){console.log("started."),webapp.acceptQueue=bgacceptqueue,bgacceptqueue=[],webapp.processAcceptQueue()}))}console.log("background onaccept"),had_backgroundaccept=!0,window.webapp&&webapp.started||(HADEVENT=!0,bgacceptqueue.push(e),getting_settings||(localOptions?(console.log("already had settings"),o(localOptions)):(getting_settings=!0,console.log("getting settings"),chrome.storage.local.get(null,o))))}function launch(e){if(HADEVENT=!0,"restart"!=(e=e||{}).source){chrome.app.window.create("react-ui/index.html",{id:"index",outerBounds:{width:410,height:700}},(function(e){window.mainWindow=e,e.onClosed.addListener(window_closed);var o=chrome.app.window.get("hidden");o&&o.close()})),window.app&&console.log("already have webapp",app)}else console.log("chrome restarted")}function teststart(){var e={port:8887,optAllInterfaces:!0,optTryOtherPorts:!0,optRetryInterfaces:!0,handlers:[]};window.webapp=new WSC.WebApplication(e),webapp.add_handler([".*",WSC.ExampleWebSocketHandler]),webapp.init_handlers(),webapp.start((function(e){console.log("webapp start result",e)}))}function get_webapp(e){return window.app||(window.app=new WSC.WebApplication(e),window.webapp=app),window.app}function get_status(){var e={};return window.app?(e.app=app,e.created=!0):e.created=!1,e}function start_app(){app&&app.start()}function stop_app(){window.app&&app.stop()}function hidden_click_configure(){launch({source:"hidden_window"})}function create_hidden(){if("Chrome"==OS&&app.opts&&app.opts.optBackground&&app.opts.optAllInterfaces){console.log("creating hidden window");chrome.app.window.create("hidden.html",{id:"hidden",hidden:!0},(function(e){e.outerBounds.setPosition(screen.width-300,screen.availHeight-120-60),e.outerBounds.setSize(300,120),e.show(),e.minimize(),e.onClosed.addListener((function(){var o=chrome.app.window.getAll();app.opts&&app.opts.optBackground&&(1==o.length&&"hidden"==e.id||0==o.length)&&setTimeout((function(){create_hidden()}),1e3)}))}))}}function window_closed(e){if(console.log("main window closed"),window.app&&app.opts&&app.opts.optBackground)return setTimeout((function(){create_hidden()}),1),void console.log("not stopping server, backgrounding mode on");console.log("main window closed. stopping server"),stop_app()}function restart(e){window.app&&(app.stop(),app.port=e,app.start())}chrome.runtime.onSuspend.addListener((function(e){console.warn("onSuspend")})),chrome.runtime.onSuspendCanceled.addListener((function(e){console.warn("onSuspendCanceled")})),chrome.runtime.onInstalled.addListener((function(){HADEVENT=!0})),chrome.app.runtime.onLaunched.addListener(launch),window.reload=chrome.runtime.reload,setTimeout((function(){HADEVENT||console.log("background page was manually reloaded in devtools? or resumed from suspended state...")}),1e3);