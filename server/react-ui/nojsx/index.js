import{AppOptions,AppOption}from"./options.js";const{FormControlLabel:FormControlLabel,Card:Card,CardContent:CardContent,Tooltip:Tooltip,FormGroup:FormGroup,Switch:Switch,AppBar:AppBar,Container:Container,Toolbar:Toolbar,Typography:Typography,Button:Button,ThemeProvider:ThemeProvider}=MaterialUI,{createMuiTheme:createMuiTheme,colors:colors,withStyles:withStyles}=MaterialUI,styles={card:{margin:"10px"},appicon:{marginRight:"10px"}},theme=createMuiTheme({palette:{primary:{main:"#3f51b5"},secondary:colors.blueGrey},status:{danger:"orange"}}),functions={optVerbose:function(e,t,a){const{bg:o}=e;o.WSC.VERBOSE=o.WSC.DEBUG=a},optAllInterfaces:function(e,t,a){e.webapp.interfaces=[]},optIPV6:function(e,t,a){e.webapp.interfaces=[]},optPreventSleep:function(e,t,a){setTimeout(()=>{e.webapp.updatedSleepSetting()},1)},optBackground:function(e,t,a){const{webapp:o,bg:n}=e;console.log("background setting changed",a),o.updateOption("optBackground",a),n.backgroundSettingChange({optBackground:a})},port:(e,t,a)=>{console.log("persist port",a),console.assert("number"==typeof a),e.webapp.opts.port=a,e.webapp.port=a},optAutoStart:function(e,t,a){const{bg:o,webapp:n}=e;function s(){console.log("persist setting start in background",a),n.opts.optBackground=a,o.backgroundSettingChange({optBackground:a})}a?chrome.permissions.request({permissions:["background"]},(function(e){console.log("request perm bg",e),e&&s()})):chrome.permissions.remove({permissions:["background"]},(function(e){console.log("drop perm bg",e),s()}))}};function setup_events(){document.body.addEventListener("keydown",(function(e){(e.metaKey||e.ctrlKey)&&82==e.keyCode&&(console.log("received ctrl(meta)-r, reload app"),window.fgapp?fgapp.reload():chrome.runtime.reload())}))}window.reload=chrome.runtime.reload,setup_events();class App extends React.Component{state={showAdvanced:!1,interfaces:[],port:6669,started:!1,starting:!1,lasterr:null,folder:null,message:""};constructor(e){super(e),this.classes=e.classes,window.app=this,console.log("app created"),this.init()}async init(){this.bg=await chromise.runtime.getBackgroundPage(),this.appOptions=new AppOptions(this.settings_ready.bind(this))}settings_ready(){const e=this.appOptions.getAll();console.log("fetched local settings",this.appOptions,e),this.webapp=this.bg.get_webapp(e),this.bg.WSC.VERBOSE=this.bg.WSC.DEBUG=this.appOptions.get("optVerbose"),this.webapp.on_status_change=this.on_webapp_change.bind(this),this.setState(e),this.on_webapp_change(),this.ui_ready()}get_status(){const e={starting:this.webapp&&this.webapp.starting,started:this.webapp&&this.webapp.started,lasterr:this.webapp&&this.webapp.lasterr,folder:this.webapp&&this.webapp.fs&&this.webapp.fs.entry&&this.webapp.fs.entry.fullPath};return e.message=this.computeMessage(e),e}computeMessage({started:e,starting:t,lasterr:a}){return a?JSON.stringify(a):t?"STARTING":e?"STARTED":"STOPPED"}on_webapp_change(){var e=this.get_status();console.log("webapp changed",e),this.setState({...e,port:this.webapp.port,interfaces:this.webapp.urls.slice()})}ui_ready(){this.webapp&&(this.webapp.started||this.webapp.starting||this.webapp.start())}choose_folder(){console.log("clicked choose folder"),chrome.fileSystem.chooseEntry({type:"openDirectory"},function(e){this.bg.onchoosefolder(e)}.bind(this))}startStop(e,t){console.log("startstop",t),t?this.webapp.start():this.webapp.stop()}onChange(e,t){console.log("update and save",e,t),this.webapp.updateOption(e,t),functions[e]&&(console.log("special handling for",e),functions[e](this,e,t)),this.appOptions.set(e,t),this.setState({[e]:t})}render(){console.assert(this);const e=e=>{const t=this;return[Object.keys(e).map(a=>{const o=e[a]||[];let n=!0,s=!1;for(const e of o)s=!0,this.state[e]||(n=!1);return React.createElement(AppOption,{indent:s,disabled:!n,onChange:this.onChange.bind(this),name:a,key:a,value:this.state[a],appOptions:t.appOptions})})]},t=e({optBackground:null,optAutoStart:["optBackground"],optAllInterfaces:null,optDoPortMapping:["optAllInterfaces"],optPreventSleep:null,optRenderIndex:null,port:null}),a=e({optCORS:null,optIPV6:null,optStatic:null,optUpload:null,optVerbose:null,optModRewriteEnable:null,optModRewriteRegexp:["optModRewriteEnable"],optModRewriteNegate:["optModRewriteEnable"],optModRewriteTo:["optModRewriteEnable"]}),o=React.createElement("div",null,React.createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.setState({showAdvanced:!this.state.showAdvanced})}},this.state.showAdvanced?"Hide Advanced Options":"Show Advanced Options")),{state:n}=this;return React.createElement("div",null,React.createElement(ThemeProvider,{theme:theme},React.createElement(AppBar,{position:"static",color:"primary"},React.createElement(Toolbar,null,React.createElement("img",{className:this.classes.appicon,src:"/images/200ok-64.png"}),React.createElement(Typography,{variant:"h6",type:"title",color:"inherit"},"meanServer"))),React.createElement(Container,null,React.createElement(Card,{className:this.classes.card},React.createElement(CardContent,null,React.createElement("p",null,"Please ",React.createElement("a",{target:"_blank",href:"https://chrome.google.com/webstore/detail/meanServer/ofhbbkphhbklhfoeikjpcbhemlocgigb/reviews"},"leave a review")," to help others find this software."))),React.createElement(Card,{className:this.classes.card},React.createElement(CardContent,null,React.createElement(FormGroup,null,React.createElement(Tooltip,{title:"Click to start or stop the meanServer"},React.createElement(FormControlLabel,{label:"meanServer: "+n.message,control:React.createElement(Switch,{disabled:n.starting,checked:n.started,onChange:this.startStop.bind(this)})}))),React.createElement("div",null,React.createElement(Button,{variant:"contained",onClick:this.choose_folder.bind(this)},"Choose Folder"),React.createElement("span",null,n.folder?" Current: "+n.folder:"NO FOLDER SELECTED")),React.createElement("h3",null,"meanServer URL(s)"),React.createElement("ul",{style:{WebkitUserSelect:"text"}},n.interfaces.map(e=>React.createElement("li",{key:e.url},React.createElement("a",{href:e.url,target:"_blank"},e.url)))))),React.createElement(Card,{className:this.classes.card},React.createElement(CardContent,null,React.createElement(Tooltip,{title:"Some options may require a restart of the server. Restart by pressing the toggle button above"},React.createElement("span",null,"Options (may require restart)")),t,o,n.showAdvanced&&React.createElement("div",null,a))),React.createElement(Card,{className:this.classes.card},React.createElement(CardContent,null,React.createElement("p",null,"Need to ",React.createElement("a",{target:"_blank",href:"https://github.com/kzahel/meanServer/issues"},"Report a problem"),"? Open source, MIT license."))))))}}const AppWithStyles=withStyles(styles)(App);ReactDOM.render(React.createElement(AppWithStyles,null),document.getElementById("app"));